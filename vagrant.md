# vagrant (2021.01.04 ~ 2021.01.10)
* 베이그런트는 가상화 소프트웨어 (버추얼박스, 도커 컨테이너, AWS 등)의 생성 및 유지보수를 위한 오픈소스 소프트웨어 제품
* 루비 언어로 작성됨
* Provision : 게스트 머신을 반복적으로 생성하고 사용하기 위해 프로비져닝으로 만들어서 사용
* Vagrant.configure("2") 의 의미
  + 여기서, configure("2")는 버전을 의미함.
  + 최근에는 "1", "2" 두 가지 버전만을 지원하며, 버전 1의 경우 Vagrant 1.0.x 버전을, 버전 2의 경우엔 1.1+ ~ 2.0.x 버전을 나타낸다.
```
Vagrant.configure("2") do |config|
  # ...
end
```
 버전별로 지원하는 configuration이 다름. 그렇기 때문에, 부득이하게 버전 1과 2의 configuration을 사용해야 한다면 다음과 같이 사용해야 함.
```
Vagrant.configure("1") do |config|
  # v1 configs...
end

Vagrant.configure("2") do |config|
  # v2 configs...
end
```
Vagrant.configure("2")에 관한 자세한 정보 : https://www.vagrantup.com/docs/vagrantfile/version
***
# 작업 LIST
## 1. Box로 VM 생성하기 (CentOS, Ubuntu 등)
* 방법1) vagrant init bento/centos-7.4 명령어로 Vagrantfile을 생성 후 생성된 파일에 다음의 내용 작성 (Vagrantfile 위치는 처음 Vagrant를 설치한 위치)
```
Vagrant.configure("2") do |config|
  config.vm.box = "bento/centos-7.2"
  config.vm.box_version = "2.3.1"
end
```
(여기서 init 파일은 VM을 구동하기 위한 메타데이터 정보를 가지고 있음)
* 방법2) vagrant가 설치된 디렉토리 상위 폴더에 Vagrantfile을 직접 생성하여 작성
## 2. VM 삭제
```diff
! TODO
```
* 삭제 명령어 : ```vagrant box remove NAME``` 
## 3. VM의 설정 변경
### 3.1. CORE & MEMORY 
* 방법1)
1. 일단 box가 실행중이라면, ```vagrant halt``` 명령어를 통해 서버를 내린다.
2. 그리고 기존 Vagrantfile 에 다음의 내용을 작성한다. 
```
Vagrant.configure("2") do |config|

  config.vm.box = "bento/centos-7.2"
  config.vm.provider "virtualbox" do |vb|
     vb.cpus = "4"
     vb.memory = "4096"
  end

end
```
3. ```vagrant up``` 명령어로 서버를 다시 올린다.

**TIP** : 다음의 설정으로 gui 및 name등을 세팅할 수 있다. 
```diff
! TODO
```
```
config.vm.provider "virtualbox" do |v|
  v.gui = true 
  # 부팅되면서 gui 환경으로 부팅
  v.name = "my_vm"
  # VirtualBox GUI에서의 name을 세팅할 수 있음
end 
```
* 방법2) ```vagrant reload``` 명령어를 통해서도 Vagrantfile 수정 후 서버를 다시 올릴 수 있다.
(주의사항 : Provision의 경우엔 --provision flag 를 사용해 줘야 reload가 됨)

### 3.2. DISK (중요)
```diff
! TODO
```

* disk types
disk (symbol)
dvd (symbol)
floppy (symbol)

```
config.vm.disk :disk, name: "backup", size: "10GB"
config.vm.disk :dvd, name: "installer", path: "./installer.iso"
config.vm.disk :floppy, name: "cool_files"
```
* 참고 : https://www.vagrantup.com/docs/disks/configuration

## 4. 포트 포워딩
- 포트를 포워딩하여 Host(local PC) port와 Guest(VM) Port를 포워딩할 수 있다.
- 
```diff
! TODO
```
```
Vagrant.configure("2") do |config|
  config.vm.network "forwarded_port", guest: 80, host: 8080
end
```
* 참고 : https://www.vagrantup.com/docs/networking/forwarded_ports
## 5. SSH 접속
 * SSH 접속 Command : ```vagrant ssh``` 

## 6. GITLAB 설치
```diff
! TODO
```
- install_gitlab.sh 라는 쉘스크립트를 Vagrantfile이 있는 디렉토리에 작성 후 저장한 뒤 ``reload --provision`` 명령어로 실행시킨다.
- install_gitlab.sh
```
echo ==== Installing GitLab CE =================================================
curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash
sudo apt-get install -y gitlab-ce
sudo gitlab-ctl reconfigure
sudo gitlab-ctl status
```
- Vagrantfile 
```
Vagrant.configure("2") do |config|
    config.vm.provision "shell", path: "install_gitlab.sh"
end
```
```diff
! TODO 여기서 Gitlab-ctl 의 의미는? 그리고 Gitlab runner란?
```
## 7. VM과 로컬 PC의 디렉토리 공유
```
Vagrant.configure("2") do |config|
  # other config here

  config.vm.synced_folder "data-vm/", "/data"
  # host 파일경로, guest 파일경로
end
```
![image](https://user-images.githubusercontent.com/57924258/103769489-b85eb480-5067-11eb-96eb-0af7477478cc.png)

* 여기서 host는 local 디렉토리, guest는 VM 디렉토리를 의미함.
* 참고 : https://www.vagrantup.com/docs/synced-folders/basic_usage
## 8. 네트워크 설정 변경
### 8.1. Private IP 설정
```diff
! TODO
```
* dhcp 방식으로 구성할 경우
```
Vagrant.configure("2") do |config|
  config.vm.network "private_network", type: "dhcp"
end
```
* static한 ip로 구성할 경우
```
Vagrant.configure("2") do |config|
  config.vm.network "private_network", ip: "192.168.50.4"
end
```
* 참고 : https://www.vagrantup.com/docs/networking/private_network
### 8.2. DHCP 설정
```diff
! TODO
```
* public IP를 DHCP 방식으로 구현할 경우
```
Vagrant.configure("2") do |config|
  config.vm.network "public_network",
    use_dhcp_assigned_default_route: true
end
```
## 9. Plugin 설치 및 사용
```diff
! TODO
```
- Plugin 설치
```
# Installing a plugin from a known gem source
$ vagrant plugin install my-plugin
```
![image](https://user-images.githubusercontent.com/57924258/103774310-b3056800-506f-11eb-8cdc-9ef154fc0934.png)
- Plugin 사용
```
# Usage plugin
# 플러그인의 사용법에 따라 달라질 수 있음
# (provisioners should be available via config.vm.provision, etc.)
```
- Plugin 삭제
```
# Removing a plugin from a known gem source
$ vagrant plugin uninstall my-plugin
```
- Plugin 업데이트
```
# Updating plugin
$ vagrant plugin update NAME
```
- Plugin 리스트
```
# Listing plugin
$ vagrant plugin list
```

**Note** : 향후에는 ```vagrant plugin``` 명령어가 각 플러그인을 설치할 때 서브명령어에 포함될 예정이다.

## 10. 기존 Box로 자체 신규 Box 만들기
```diff
! TODO 이게 맞는지 잘 모르겠는데.. 다른 방법도 찾아보자
```
* Linked clones는 master VM을 기반으로 box를 처음 한번 import할 때 필요하다. linked clones는 master VM에 속한 상위 디스크 이미지와 다를 때 생성한다.
Linked clones are based on a master VM, which is generated by importing the base box only once the first time it is required. For the linked clones only differencing disk images are created where the parent disk image belongs to the master VM.

```
config.vm.provider "virtualbox" do |v|
  v.linked_clone = true
end
```

## 11. 신규 Box 파일을 웹 서버에 올려놓고 자체 Box 서버를 통해 Box 파일 내려받기
```diff
! TODO
```

*참고 : 코드 색상표
```diff
- text in red
+ text in green
! text in orange
# text in gray
```
